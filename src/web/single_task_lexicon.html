<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="single_task_lexicon.css">
    <title>Single Task Lexicon</title>
</head>

<!-- JS for maneuvering text -->
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script>
    spanToEntity = {};
    // List of entities to include in dropdown -- TODO: Will probably need to reformat using Jinja
    array = ["UIUC", "Columbia", "Ford", "GE"];
    highlighted =  "";

    // TODO: Submit data to server before reloading
    function submitHIT(){
        location.reload();
    }

    // Add dropdown on load
    window.onload = function(){
        var entities = document.getElementById("entities");
        var selectList = document.createElement("select");
        selectList.id = "entitiesSelect";
        entities.appendChild(selectList);

        //Create and append the options for dropdown
        for (var i = 0; i < array.length; i++) {
            var option = document.createElement("option");
            option.value = array[i];
            option.text = array[i];
            selectList.appendChild(option);
        }

        // Submit button for entity
        var submit = document.createElement("INPUT");
        submit.setAttribute("class", "submitButton")
        submit.setAttribute("type", "button");
        submit.setAttribute("value", "Select Item");
        submit.onclick = function(){
            getSelected(highlighted)
        };
        entities.appendChild(submit);
    }


    // Highlight text and give option for selecting matching entity
    function highlightText(){
        if (window.getSelection){
            var entities = document.getElementById("entities");
            //entities.innerHTML = "";
            var selection = window.getSelection();
            var selectionStr = selection.toString();

            for(var i = 0; i < selection.rangeCount; i++) {
                highlightRange(selection.getRangeAt(i));
            }

            updateSelected(selectionStr);
        }
    }

    // Get element from dropdown that has been selected
    function getSelected(span){
        if (highlighted == ""){
            window.alert("You have not highlighted any span of text!");
        }else{
            // Get element selected
            var e = document.getElementById("entitiesSelect");
            var entityPicked = e.options[e.selectedIndex].value;
            spanToEntity[span] = entityPicked;

            // Add to table of span: entity
            selectedEntitiesTable = document.getElementById("selectedentities");
            console.log(selectedEntitiesTable.rows.length);
            var newRow = selectedEntitiesTable.insertRow(selectedEntitiesTable.rows.length);

            // Add span
            var newSpan  = newRow.insertCell(0);
            // Append a text node to the cell
            var newText  = document.createTextNode(span);
            newSpan.appendChild(newText);

            // Add entity
            var newEntity = newRow.insertCell(1);
            // Append a text node to the cell
            var newText  = document.createTextNode(entityPicked);
            newEntity.appendChild(newText);

            console.log(spanToEntity);
        }

    }

    // Update selected text to be filled into span-> entity table
    function updateSelected(textHighlighted){
        highlighted = textHighlighted;
    }


    // Highlight the range of text in yellow
    function highlightRange(range) {
        var newNode = document.createElement("span");
        newNode.setAttribute(
            "style",
            "background-color: yellow; display: inline;"
        );
        range.surroundContents(newNode);
    }


    // Clear all highlighting from span of text
    function clearSpans(){
        var spans = $(".text").find("span").contents().unwrap();
        // Reset span to entity mapping
        spanToEntity = {};
        text = ""

        // Clear rows in table
        selectedEntitiesTable = document.getElementById("selectedentities");
        numRows = selectedEntitiesTable.rows.length;
        for (var n = 1; n < numRows; n++){
            selectedEntitiesTable.deleteRow(1);
        }
    }

</script>


<body >
    <div class="wrapper" >
        <header>
            <h1><b>Instructions</b></h1> <br>
               <span style="text-align:center;"> Below you will be presented with a dialogue between two individuals
               discussing their friends. Their friends have a number of different attributes, including occcupation and
               schools where they studied. All of these attributes are listed in the table below. Your task is as follows:</span> <br> <br>

                <ul style="margin-left: 30px;">
                <li>Highlight each span of text in every line in the dialogue that may refer to an item in the table</li>
                appear below the dialogue.</li>
                <li> Once you highlight the appropriate span of text, select the item from the dropdown that corresponds to the span of text you have identified. For example,
                the dialogue may use <span style="color:red">UPenn</span> to refer to the item <span style="color:green">University of Pennsylvania</span>.</li>
                <li> Once you have selected the correct entity, click the <span style="color:blue"> Select Item </span> button. The span of text and the entity you
                selected will appear as a row in the table below the dropdown.</li>
                <li>Highlight <b>EVERY</b> span of text in the dialogue that refers to an entity in the table, or
                <b>your work will be rejected</b>.</li>
                <li>If you have made a mistake, you can clear the entities you have highlighted by clicking the <span style="color: purple">Clear Highlighting</span>
                    button at the bottom of the page.</li>
                <li> Once you are done highlighting <strong> ALL </strong> spans of text, click the <span style="color:red"> Submit HIT</span> button.</li>
                <li> NOTE: Please only highlight one span of text at a time!</li> <br>
                </ul>
        </header>
        <br>
        <br>
        <div class="kb">
        <table align="middle" border="1">
        <tr>
            <th>Name</th>
            <th>School</th>
            <th>Employer</th>
        </tr>
        <tr>
            <td>John </td>
            <td>Columbia </td>
            <td>Ford</td>
        </tr>
        <tr>
            <td>Anna </td>
            <td>University of Illinois Urbana-Champagna</td>
            <td>GE</td>
        </tr>

        </table>

        </div>
        <br> <br>

        <!-- Fill in a dialogue here -->
        <div class="text" onmouseup="highlightText()">
        <p> Agent 1: I'm from Columbia, majored in physics. </p>
            <br>
            <p> Agent 0: I went to University of Pensylvania and most my friends are from there.</p>
            <br>
        <p>Agent 1: I have a single Apple friend.</p>
            <br>
           <p> Agent 0: I work at Apple and all but one of my friends do, too,</p>
            <br>
            <p>Agent 0: Who is your Apple friend?</p>
            <br>
        <p>Agent 1: All my Penn friend works for Amazon.</p>
            <br>
            <p>Agent 1: Laverna</p>
            <br>
            <p>Agent 0: Nope. Do you know Colin who works at Amazon?</p>
            <br>
            <p>Agent 1: Yes!</p>
        </div>
        <br>

        <!-- Will be filled in with dropdown to be used for selecting entities-->
        <div id="entities"> </div>

        <br>

        <table id="selectedentities" align="middle" border="1" width="700">
        <tr>
            <th>Span</th>
            <th>Entity</th>
        </tr>


        </table>

        <br>

        <div class="buttons" style="text-align:center;">
         <button type="button" onclick="clearSpans()">Clear Highlighting!</button>
         <button type="button" onclick="submitHIT()">Submit HIT!</button>
        </div>

    </div>


</body>
</html>