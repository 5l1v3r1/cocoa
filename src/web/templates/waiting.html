<html>
    <head>
        <title>Who's Our Mutual Friend?</title>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css')}}">
        <style>
    		#timer{
    		color: #000;
    		display: inline-block;
    		text-align: center;
    		}

    		#timer > div{
    			display: inline-block;
    			font-size: 20px;
    		}

    		#timer div > span{
    			font-weight: bolder;
    			font-size: 20px;	
    			display: inline-block;
    		}
    		
    		#timer div > .seconds{
    			margin-left:-3px;
    		}
        </style>
        
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var pollInterval;
            var BASE_URL = 'http://' + document.domain + ':' + location.port;
            $(document).ready(function(){
            	$.ajax({
            		url: BASE_URL +'/_connect/',
            		type: "get",
            		data: {"uid": "{{ uid }}" },
            		dataType: "json"
            	});
          		pollInterval = setInterval(pollServer, 1000);
                window.onbeforeunload = disconnect;
            });
    
            function pollServer() {
            	$.ajax({
            		url: BASE_URL +'/_check_status_change/',
            		type: "get",
            		data: {"uid": "{{ uid }}", "assumed_status": "waiting"},
            		dataType: "json",
            		success: function(response) {
            			if (response['status_change']) {
            				disconnect();
            				window.location.reload(true);
                    	}
            		}
            	});
            }

            function disconnect() {
            	clearInterval(pollInterval);
            	$.ajax({
            		url: BASE_URL + '/_disconnect/',
            		type: "get",
            		data: {"uid": "{{ uid }}" },
            		dataType: "json"
            	});
            }

        </script>
        <script type="text/javascript" charset="utf-8">
			function getTimeRemaining(endtime) {
			  var t = Date.parse(endtime) - Date.parse(new Date());
			  var seconds = Math.floor((t / 1000) % 60);
			  var minutes = Math.floor((t / 1000 / 60));
			  return {
				'total': t,
				'minutes': minutes,
				'seconds': seconds
			  };
			}
			function init() {
			  var deadline = new Date(Date.parse(new Date()) + {{ seconds_until_expiration }} * 1000);
			  initializeClock('timer', deadline);
			}
			function initializeClock(id, endtime) {
			  var clock = document.getElementById(id);
			  var minutesSpan = clock.querySelector('.minutes');
			  var secondsSpan = clock.querySelector('.seconds');

			  function updateClock() {
				var t = getTimeRemaining(endtime);
				
				if (t.total <= 0) {
					clearInterval(timeinterval);
				}
				
				if (t.total >=0) {
					minutesSpan.innerHTML = t.minutes+':';
					secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);
				}

			  }

			  updateClock();
			  var timeinterval = setInterval(updateClock, 1000);
			}
        </script>
    </head>
    <body onload="init()">
    <div id="content">
        <h2>Who's Our Mutual Friend?</h2>
        <div id="timer">
            <div>
                Time left to wait:
            </div>
            <div style="padding: 0 0 0 30px;">
            <span class="minutes"></span>
            </div>
            <div>
            <span class="seconds"></span>
            </div>
        </div>
        <div>
            <h3>{{ waiting_message }}</h3>

            <h4>When we pair you with another user, you'll see a page containing a chat box and the instructions for a timed task that involves using the chat interface to chat with the other user. Be sure to read the instructions carefully while completing the task. </h4>
        </div>
    </div>

    </body>
</html>